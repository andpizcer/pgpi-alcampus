{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="section-content padding-y bg">
    <div class="container">

    <div class="row">
        <aside class="col-lg-8">
            <div class="card">
                <h5 class="card-header">Dirección de Facturación</h5>
                <div class="card-body">
                    <p>{{ order.full_name }}</p>
                    <p>{{ order.full_address }}</p>
                    <p>{{ order.city }}, {{ order.state }}</p>
                    <p>{{ order.country }}</p>
                    <p>{{ order.email }}</p>
                    <p>{{ order.phone }}</p>
                </div>
            </div>

            <div class="card">
                <h5 class="card-header">Revisión de Productos</h5>
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.items.all %}
                            <tr>
                                <td>{{ item.product.product_name }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>${{ item.product_price }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </aside>

        <aside class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <dl>
                        <dt>Total:</dt>
                        <dd>${{ grand_total }}</dd>
                        <dt>Impuesto IVA:</dt>
                        <dd>${{ tax }}</dd>
                        <dt>Total Final:</dt>
                        <dd>${{ grand_total }}</dd>
                    </dl>
                    <div id="paypal-button-container"></div>
                </div>
            </div>
        </aside>
    </div>
    </div>
</section>

<script>
    var amount = "{{ grand_total }}";
    var url = "{% url 'payments' %}";
    var csrftoken = getCookie('csrftoken');
    var orderID = "{{ order.order_number }}";

    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: amount
                    }
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(orderData) {
                sendData();
                function sendData() {
                    fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrftoken,
                        },
                        body: JSON.stringify({
                            orderID: orderID,
                            transID: orderData.id,
                            payment_method: 'Paypal',
                            status: orderData.status
                        }),
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        window.location.href = "{% url 'order_complete' %}?order_number=" + data.order_number + "&payment_id=" + data.transID;
                    });
                }
            });
        }
    }).render('#paypal-button-container');
</script>

{% endblock %}

